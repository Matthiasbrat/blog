---
import ArticleLayout from '../../layouts/ArticleLayout.astro';
import { getSectionBySlug } from '../../lib/sections';
import { getFlatContentBySlug, getFlatContent } from '../../lib/content';

export async function getStaticPaths() {
  const { getFlatContent } = await import('../../lib/content');
  const projects = getFlatContent('projects');
  
  return projects.map(project => ({
    params: { slug: project.slug }
  }));
}

const { slug } = Astro.params;
const section = getSectionBySlug('projects');
const projectData = getFlatContentBySlug('projects', slug!);

if (!projectData) {
  return Astro.redirect('/404');
}

const { meta, content } = projectData;

// Simple markdown to HTML
function renderContent(md: string): string {
  return md
    .replace(/^# .+$/m, '')
    .replace(/^## (.+)$/gm, (_, t) => `<h2 id="${t.toLowerCase().replace(/[^a-z0-9]+/g, '-')}">${t}</h2>`)
    .replace(/^### (.+)$/gm, (_, t) => `<h3>${t}</h3>`)
    .replace(/```(\w+)?\n([\s\S]*?)```/g, (_, lang, code) => `<pre><code>${code.trim()}</code></pre>`)
    .replace(/`([^`]+)`/g, '<code>$1</code>')
    .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
    .replace(/\*([^*]+)\*/g, '<em>$1</em>')
    .replace(/^\- (.+)$/gm, '<li>$1</li>')
    .replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>')
    .replace(/^\d+\. (.+)$/gm, '<li>$1</li>')
    .replace(/^(?!<[huplo]|$)(.+)$/gm, '<p>$1</p>')
    .replace(/<\/ul>\n<ul>/g, '')
    .trim();
}
---

<ArticleLayout
  title={meta.title}
  description={meta.description}
  showComments={false}
  showDate={false}
>
  <Fragment set:html={renderContent(content)} />
  
  <p class="back"><a href="/projects">‚Üê All projects</a></p>
</ArticleLayout>

<style>
  .back {
    margin-top: var(--space-xl);
    padding-top: var(--space-lg);
    border-top: 1px solid var(--color-border);
    font-size: 0.9375rem;
  }
  
  .back a {
    color: var(--color-text-muted);
  }
</style>
