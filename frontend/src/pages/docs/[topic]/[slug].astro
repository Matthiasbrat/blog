---
import DocsLayout from '../../../layouts/DocsLayout.astro';
import { getSectionBySlug } from '../../../lib/sections';
import { getTopicBySlug, getContentForTopic, getContentBySlug } from '../../../lib/content';

export async function getStaticPaths() {
  const { getTopicsForSection, getContentForTopic } = await import('../../../lib/content');
  const topics = getTopicsForSection('docs');
  
  const paths = [];
  for (const topic of topics) {
    const docs = getContentForTopic('docs', topic.slug);
    for (const doc of docs) {
      paths.push({
        params: { topic: topic.slug, slug: doc.slug }
      });
    }
  }
  
  return paths;
}

const { topic: topicSlug, slug } = Astro.params;
const section = getSectionBySlug('docs');
const docData = getContentBySlug('docs', topicSlug!, slug!);

if (!docData) {
  return Astro.redirect('/404');
}

const { meta, content } = docData;

// Get prev/next
const allDocs = getContentForTopic('docs', topicSlug!);
const currentIndex = allDocs.findIndex(d => d.slug === slug);
const prevDoc = currentIndex > 0 ? allDocs[currentIndex - 1] : null;
const nextDoc = currentIndex < allDocs.length - 1 ? allDocs[currentIndex + 1] : null;

// Simple markdown to HTML
function renderContent(md: string): string {
  return md
    .replace(/^# .+$/m, '')
    .replace(/^## (.+)$/gm, (_, t) => `<h2 id="${t.toLowerCase().replace(/[^a-z0-9]+/g, '-')}">${t}</h2>`)
    .replace(/^### (.+)$/gm, (_, t) => `<h3>${t}</h3>`)
    .replace(/```(\w+)?\n([\s\S]*?)```/g, (_, lang, code) => `<pre><code>${code.trim()}</code></pre>`)
    .replace(/`([^`]+)`/g, '<code>$1</code>')
    .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
    .replace(/\*([^*]+)\*/g, '<em>$1</em>')
    .replace(/^\- (.+)$/gm, '<li>$1</li>')
    .replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>')
    .replace(/^\d+\. (.+)$/gm, '<li>$1</li>')
    .replace(/^(?!<[huplo]|$)(.+)$/gm, '<p>$1</p>')
    .replace(/<\/ul>\n<ul>/g, '')
    .trim();
}
---

<DocsLayout
  title={meta.title}
  description={meta.description}
  updated={meta.updated || meta.date}
  showComments={section?.features?.comments ?? true}
  showPrevNext={true}
  prevPost={prevDoc ? { title: prevDoc.title, href: `/docs/${topicSlug}/${prevDoc.slug}` } : undefined}
  nextPost={nextDoc ? { title: nextDoc.title, href: `/docs/${topicSlug}/${nextDoc.slug}` } : undefined}
>
  <Fragment set:html={renderContent(content)} />
</DocsLayout>
