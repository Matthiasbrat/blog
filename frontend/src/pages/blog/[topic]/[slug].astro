---
import ArticleLayout from '../../../layouts/ArticleLayout.astro';
import { getSectionBySlug } from '../../../lib/sections';
import { getTopicBySlug, getContentForTopic, getContentBySlug } from '../../../lib/content';

export async function getStaticPaths() {
  const { getTopicsForSection, getContentForTopic } = await import('../../../lib/content');
  const topics = getTopicsForSection('blog');
  
  const paths = [];
  for (const topic of topics) {
    const posts = getContentForTopic('blog', topic.slug);
    for (const post of posts) {
      paths.push({
        params: { topic: topic.slug, slug: post.slug }
      });
    }
  }
  
  return paths;
}

const { topic: topicSlug, slug } = Astro.params;
const section = getSectionBySlug('blog');
const postData = getContentBySlug('blog', topicSlug!, slug!);

if (!postData) {
  return Astro.redirect('/404');
}

const { meta, content } = postData;

// Simple markdown to HTML
function renderContent(md: string): string {
  return md
    .replace(/^# .+$/m, '') // Remove h1
    .replace(/^## (.+)$/gm, (_, t) => `<h2 id="${t.toLowerCase().replace(/[^a-z0-9]+/g, '-')}">${t}</h2>`)
    .replace(/^### (.+)$/gm, (_, t) => `<h3>${t}</h3>`)
    .replace(/```(\w+)?\n([\s\S]*?)```/g, (_, lang, code) => `<pre><code>${code.trim()}</code></pre>`)
    .replace(/`([^`]+)`/g, '<code>$1</code>')
    .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
    .replace(/\*([^*]+)\*/g, '<em>$1</em>')
    .replace(/^\- (.+)$/gm, '<li>$1</li>')
    .replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>')
    .replace(/^\d+\. (.+)$/gm, '<li>$1</li>')
    .replace(/^(?!<[huplo]|$)(.+)$/gm, '<p>$1</p>')
    .replace(/<\/ul>\n<ul>/g, '')
    .trim();
}
---

<ArticleLayout
  title={meta.title}
  description={meta.description}
  date={meta.date}
  updated={meta.updated}
  showComments={section?.features?.comments ?? false}
  showDate={true}
>
  <Fragment set:html={renderContent(content)} />
  
  <p class="back"><a href={`/blog/${topicSlug}`}>‚Üê Back to {topicSlug}</a></p>
</ArticleLayout>

<style>
  .back {
    margin-top: var(--space-xl);
    padding-top: var(--space-lg);
    border-top: 1px solid var(--color-border);
    font-size: 0.9375rem;
  }
  
  .back a {
    color: var(--color-text-muted);
  }
</style>
