---
import BaseLayout from '../../../layouts/ArticleLayout.astro';
import Comments from '../../../components/features/Comments.astro';
import { getSectionBySlug } from '../../../lib/sections';
import { getTopicBySlug, getContentForTopic, getContentBySlug } from '../../../lib/content';

export async function getStaticPaths() {
  const { getTopicsForSection, getContentForTopic } = await import('../../../lib/content');
  const topics = getTopicsForSection('blog');
  
  const paths = [];
  for (const topic of topics) {
    const posts = getContentForTopic('blog', topic.slug);
    for (const post of posts) {
      paths.push({ params: { topic: topic.slug, slug: post.slug } });
    }
  }
  return paths;
}

const { topic: topicSlug, slug } = Astro.params;
const section = getSectionBySlug('blog');
const topic = getTopicBySlug('blog', topicSlug!);
const postData = getContentBySlug('blog', topicSlug!, slug!);

if (!postData) {
  return Astro.redirect('/404');
}

const { meta, content } = postData;

function formatDate(d: Date): string {
  return d.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
}

function renderContent(md: string): string {
  return md
    .replace(/^# .+$/m, '')
    .replace(/^---$/gm, '<hr class="decorated">')
    .replace(/^## (.+)$/gm, (_, t) => `<h2 id="${t.toLowerCase().replace(/[^a-z0-9]+/g, '-')}">${t}</h2>`)
    .replace(/^### (.+)$/gm, (_, t) => `<h3>${t}</h3>`)
    .replace(/```(\w+)?\n([\s\S]*?)```/g, (_, lang, code) => `<pre><code>${code.trim().replace(/</g, '&lt;').replace(/>/g, '&gt;')}</code></pre>`)
    .replace(/`([^`]+)`/g, '<code>$1</code>')
    .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
    .replace(/\*([^*]+)\*/g, '<em>$1</em>')
    .replace(/^\- (.+)$/gm, '<li>$1</li>')
    .replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>')
    .replace(/^\d+\. (.+)$/gm, '<li>$1</li>')
    .replace(/^(?!<[huplo]|$)(.+)$/gm, '<p>$1</p>')
    .replace(/<\/ul>\n<ul>/g, '')
    .trim();
}

const topicStyles: Record<string, string> = {
  javascript: 'var(--pastel-orange)',
  typescript: 'var(--pastel-blue)',
  rust: 'var(--pastel-pink)',
};
---

<BaseLayout title={meta.title} description={meta.description} article={true}>
  <article>
    <header class="article-header container-narrow">
      <div class="article-meta">
        <a href={`/blog/${topicSlug}`} class="article-tag" style={`background: ${topicStyles[topicSlug!] || 'var(--pastel-green)'}`}>{topic?.name}</a>
        <span>·</span>
        <time datetime={meta.date?.toISOString()}>{formatDate(meta.date)}</time>
        <span>·</span>
        <span>{meta.readingTime} min read</span>
      </div>
      <h1>{meta.title}</h1>
      {meta.description && <p class="article-excerpt">{meta.description}</p>}
    </header>
    
    <div class="container-narrow">
      <div class="article-content content" data-pagefind-body>
        <Fragment set:html={renderContent(content)} />
      </div>
      
      <hr>
      
      <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: var(--space-md);">
        <a href={`/blog/${topicSlug}`} class="btn btn-secondary">
          ← More {topic?.name} articles
        </a>
        <a href="/blog" class="btn btn-secondary">
          All topics
        </a>
      </div>
      
      {section?.features.comments && <Comments />}
    </div>
  </article>
</BaseLayout>
